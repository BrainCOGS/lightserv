{% extends "layout.html" %}
{% block content %}
	{% set channel_wavelengths = ['488','555','647','790'] %}
	<h1 id='primary_header' align="center">New Request Form</h1>
	 <div class="content-section">

		<form method="POST" action="">
			{{ form.hidden_tag() }}
			<fieldset class="form-group">
				<legend class="border-bottom mb-2 mt-4">Background Info</legend>
				<div class="form-group">
					{% if form.labname.flags.required %}*{% endif %}
					{{ form.labname.label(class="form-control-label") }}
					{% if form.labname.errors %}
						{{ form.labname(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.labname.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.labname(class="form-control form-control-lg") }}
					{% endif %}
				</div>
				<div class="form-group">
					{% if form.correspondence_email.flags.required %}*{% endif %}
					{{ form.correspondence_email.label(class="form-control-label") }}
					{% if form.correspondence_email.errors %}
						{{ form.correspondence_email(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.correspondence_email.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.correspondence_email(class="form-control form-control-lg") }}
					{% endif %}
				</div>
				<div class="form-group">
					{% if form.experiment_name.flags.required %}*{% endif %}
					{{ form.experiment_name.label(class="form-control-label") }}
					{% if form.experiment_name.errors %}
						{{ form.experiment_name(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.experiment_name.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.experiment_name(class="form-control form-control-lg") }}
					{% endif %}
				</div>
				<div class="form-group">
					{% if form.description.flags.required %}*{% endif %}
					{{ form.description.label(class="form-control-label") }}
					{% if form.description.errors %}
						{{ form.description(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.description.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.description(class="form-control form-control-lg") }}
					{% endif %}
				</div>
				<div class="form-group">
					{% if form.species.flags.required %}*{% endif %}
					{{ form.species.label(class="form-control-label mr-2") }}
					{{ form.species(class="form-control form-control-lg border-bottom") }}
				</div>

				<div class="form-group">
					{% if form.number_of_samples.flags.required %}*{% endif %}
					{{ form.number_of_samples.label(class="form-control-label") }}
					{% if form.number_of_samples.errors %}
						{{ form.number_of_samples(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.number_of_samples.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.number_of_samples(class="form-control form-control-lg") }}
					{% endif %}
				</div>

				<div class="form-group">
					{% if form.sample_prefix.flags.required %}*{% endif %}
					{{ form.sample_prefix.label(class="form-control-label") }}
					{% if form.sample_prefix.errors %}
						{{ form.sample_prefix(class="form-control form-control-lg is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.sample_prefix.errors %}
								<span>{{ error }}</span>
							{% endfor %}
						</div>
					{% else %}
						{{ form.sample_prefix(class="form-control form-control-lg") }}
					{% endif %}
				</div>

				<!-- ############### -->
				<!-- SAMPLES section -->
				<!-- ############### -->
				<hr class='class-3'>
				<h3 class='border-bottom'>Samples setup</h3>
				<div class="checkbox">
					{{ form.uniform_clearing(class="form-check-input" ) }}
					{{ form.uniform_clearing.label(class="form-check-label") }}
				</div>
				<div class="checkbox">
					{{ form.uniform_imaging(class="form-check-input") }}
					{{ form.uniform_imaging.label(class="form-check-label") }}
				</div>
				<hr class='class-2'>
				<div class="checkbox">
                    {{ form.self_clearing(class="form-check-input") }}
                    {{ form.self_clearing.label(class="form-check-label") }}
                </div>
                <div class="checkbox">
                    {{ form.self_imaging(class="form-check-input") }}
                    {{ form.self_imaging.label(class="form-check-label") }}
                </div>

				<div class="form-group">
					{{ form.sample_submit_button(class="btn btn-success mt-2") }}
				</div>
				
				<!-- ################ -->
				<!-- CLEARING section -->
				<!-- ################ -->
				
				{% if form.clearing_samples.data|length > 0 %}
					<hr class='class-2'>
					<h3 class='border-bottom'>Clearing setup</h3>
				{% endif %}
				<div>
					{% for clearing_entry in form.clearing_samples %}
						{% if form.uniform_clearing.data == false %}
							<!-- Render the hiddenfield sample_name to keep track of it in debugging -->
							{{ clearing_entry.sample_name }}
					        <legend class="form-control-label">Sample {{ loop.index }}: {{form.sample_prefix.data }}-{{ loop.index }} </legend>
						
					    {% else %}
					    	<legend class="form-control-label">Sample {{ loop.index }}: {{form.sample_prefix.data }}-{{ loop.index }} <br/>(Your entries below will apply to all of your samples) </legend>
						{% endif %}
				        <hr>

				        <div class="form-group">
							{% if clearing_entry.perfusion_date.flags.required %}*{% endif %}
							{{ clearing_entry.perfusion_date.label(class="form-control-label") }}
							{% if clearing_entry.perfusion_date.errors %}
								{{ clearing_entry.perfusion_date(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.perfusion_date.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.perfusion_date(class="form-control form-control-lg") }}
							{% endif %}
						</div>

						<div class="form-group">
							{% if clearing_entry.expected_handoff_date.flags.required %}*{% endif %}
							{{ clearing_entry.expected_handoff_date.label(class="form-control-label") }}
							{% if clearing_entry.expected_handoff_date.errors %}
								{{ clearing_entry.expected_handoff_date(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.expected_handoff_date.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.expected_handoff_date(class="form-control form-control-lg") }}
							{% endif %}
						</div>

				        <div class="form-group">
							{% if clearing_entry.clearing_protocol.flags.required %}*{% endif %}
							{{ clearing_entry.clearing_protocol.label(class="form-control-label") }}
							{% if clearing_entry.clearing_protocol.errors %}
								{{ clearing_entry.clearing_protocol(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.clearing_protocol.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.clearing_protocol(class="form-control form-control-lg") }}
							{% endif %}
						</div>

						
						<div class="form-group">
							{% if clearing_entry.antibody1.flags.required %}*{% endif %}
							{{ clearing_entry.antibody1.label(class="form-control-label") }}
							{% if clearing_entry.antibody1.errors %}
								{{ clearing_entry.antibody1(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.antibody1.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.antibody1(class="form-control form-control-lg") }}
							{% endif %}
						</div>

						<div class="form-group">
							{% if clearing_entry.antibody2.flags.required %}*{% endif %}
							{{ clearing_entry.antibody2.label(class="form-control-label") }}
							{% if clearing_entry.antibody2.errors %}
								{{ clearing_entry.antibody2(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.antibody2.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.antibody2(class="form-control form-control-lg") }}
							{% endif %}
						</div>

						<div class="form-group">
							{% if clearing_entry.notes_for_clearer.flags.required %}*{% endif %}
							{{ clearing_entry.notes_for_clearer.label(class="form-control-label") }}
							{% if clearing_entry.notes_for_clearer.errors %}
								{{ clearing_entry.notes_for_clearer(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in clearing_entry.notes_for_clearer.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ clearing_entry.notes_for_clearer(class="form-control form-control-lg") }}
							{% endif %}
						</div>

					{% if not loop.last %}
						<br/>
		            	<hr class='class-2'>
		            {% endif %}

					{% endfor %}
				</div>

				<!-- ############### -->
				<!-- IMAGING section -->
				<!-- ############### -->
				
				{% if form.imaging_samples.data|length > 0 %}
					<hr class='class-2'>
					<h3 class='border-bottom'>Imaging/Processing setup</h3>
				{% endif %}
				<div>
					<!-- Loop through imaging samples -->
					{% for imaging_entry in form.imaging_samples %}

						<!-- Render the hiddenfield sample_name to keep track of it in debugging -->
						{{ imaging_entry.sample_name }}

						<!-- Handle what the sample name looks like depending on whether 
						uniform_imaging was selected -->
						{% if form.uniform_imaging.data == false %}
					        <legend class="form-control-label">Sample {{ loop.index }}: {{form.sample_prefix.data }}-{{ loop.index }} </legend>
					    {% else %}
					    	<legend class="form-control-label">Sample {{ loop.index }}: {{form.sample_prefix.data }}-{{ loop.index }} <br/>(Your entries below will apply to all of your samples) </legend>
						{% endif %}
				        <hr class='class-2'>

				        <!-- Loop through all image resolution forms and make a table for each -->
						{% for image_resolution_form in imaging_entry.resolution_table_fieldlist %}
							<!-- render the hidden field -->
							{{ image_resolution_form.image_resolution() }}
							<h4 > Set up for image resolution: {{ image_resolution_form.image_resolution.data }} </h4>
							<a> Select all imaging channels and their uses: </a>
							<table class="table table-bordered table-striped text-center mb-4">
				                <tr>
				                    <th>Channel wavelength(nm)</th>
				                    <th>Image resolution</th>
				                    <th>Registration</th>
				                    <th>Injection detection</th>
				                    <th>Probe detection</th>
				                    <th>Cell detection</th>
				                </tr>

				                {% for channel_entry in image_resolution_form.channels %}
					                <!-- Render the channel_name which is a hidden field just so it is set -->
				                	{{ channel_entry.channel_name() }} 
				                	{% set channel_wavelength = channel_wavelengths[loop.index-1] %}
					                <tr>   
					                    <td>{{channel_wavelength}}</td>
					                    <td>{{ image_resolution_form.image_resolution.data }}</td>
					                    <td>{{channel_entry.registration}}</td>
					                    <td>{{channel_entry.injection_detection}}</td>
					                    <td>{{channel_entry.probe_detection}}</td>
					                    <td>{{channel_entry.cell_detection}}</td>
					                </tr>
				               {% endfor %}
				            </table>

				             <div class="form-group">
								{% if image_resolution_form.notes_for_imager.flags.required %}*{% endif %}
								{{ image_resolution_form.notes_for_imager.label(class="form-control-label") }}
								{% if image_resolution_form.notes_for_imager.errors %}
									{{ image_resolution_form.notes_for_imager(class="form-control form-control-lg is-invalid") }}
									<div class="invalid-feedback">
										{% for error in image_resolution_form.notes_for_imager.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ image_resolution_form.notes_for_imager(class="form-control form-control-lg") }}
								{% endif %}
							</div>

							<div class="form-group">
								{% if image_resolution_form.notes_for_processor.flags.required %}*{% endif %}
								{{ image_resolution_form.notes_for_processor.label(class="form-control-label") }}
								{% if image_resolution_form.notes_for_processor.errors %}
									{{ image_resolution_form.notes_for_processor(class="form-control form-control-lg is-invalid") }}
									<div class="invalid-feedback">
										{% for error in image_resolution_form.notes_for_processor.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ image_resolution_form.notes_for_processor(class="form-control form-control-lg") }}
								{% endif %}
							</div>

							<div class="form-group">
								{% if image_resolution_form.atlas_name.flags.required %}*{% endif %}
								{{ image_resolution_form.atlas_name.label(class="form-control-label") }}
								{% if image_resolution_form.atlas_name.errors %}
									{{ image_resolution_form.atlas_name(class="form-control form-control-lg is-invalid") }}
									<div class="invalid-feedback">
										{% for error in image_resolution_form.atlas_name.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ image_resolution_form.atlas_name(class="form-control form-control-lg") }}
								{% endif %}
							</div>

			            	<hr class='class-2'>
			            

						{% endfor %}

						<!-- Make the image resolution select field and button for making a new table of channels -->
						<div class="form-group">
							{{ imaging_entry.image_resolution_forsetup.label(class="form-control-label") }}
							{% if imaging_entry.image_resolution_forsetup.errors %}
								{{ imaging_entry.image_resolution_forsetup(class="form-control form-control-lg is-invalid") }}
								<div class="invalid-feedback">
									{% for error in imaging_entry.image_resolution_forsetup.errors %}
										<span>{{ error }}</span>
									{% endfor %}
								</div>
							{% else %}
								{{ imaging_entry.image_resolution_forsetup(class="form-control form-control-lg") }}
							{% endif %}
						</div>
				        <div class="form-group">
							{{ imaging_entry.new_resolution_table_submit(class="btn btn-success mt-2") }}
						</div>


			            {% if not loop.last %}
			            	<br/>
			            	<hr class='class-2'>
			            {% endif %}
					{% endfor %}
				</div>


			</fieldset>
			<hr class='class-3'>
			<hr class='class-4'>
			<div class="form-group">
				{{ form.submit(class="btn btn-success mt-2") }}
			</div>
	
		</form>
	</div>

<!-- For focusing to a given tag -->
{% if column_name %}
	<script>
	window.onload = function() {
	  document.getElementById("{{column_name}}").focus();
	};
	</script>
{% endif %}
{% endblock content %}